events {
    worker_connections 1024;
}

http {
    resolver 127.0.0.11 valid=30s ipv6=off;

    upstream oauth2-proxy {
        zone oauth2_proxy 64k;
        server oauth2-proxy:4180 resolve;
    }

    upstream httpbin {
        zone httpbin 64k;
        server httpbin:80 resolve;
    }

    upstream nextapp {
        zone nextapp 64k;
        server app:3000 resolve;
    }

    # Authorization ヘッダーから Bearer トークンを抽出
    map $authz $id_token {
        default "";
        "~^Bearer\s+(.+)$" $1;
    }

    # ログ表示用: 空文字を "-" に変換
    map $email $email_safe {
        ""      "-";
        default $email;
    }
    map $user $user_safe {
        ""      "-";
        default $user;
    }

    log_format json escape=json
        '{'
            '"time":"$time_iso8601",'
            '"remote_addr":"$remote_addr",'
            '"method":"$request_method",'
            '"uri":"$request_uri",'
            '"status":$status,'
            '"bytes":$body_bytes_sent,'
            '"referer":"$http_referer",'
            '"ua":"$http_user_agent",'
            '"req_time":$request_time,'
            '"up_resp_time":"$upstream_response_time",'
            '"user":"$user_safe",'
            '"email":"$email_safe",'
            '"req_id":"$request_id"'
        '}';

    server {
        listen 8000;
        server_name _;

        access_log /dev/stdout json;
        error_log  /dev/stderr warn;

        # ── ヘルスチェック (認証不要) ─────────────────────────
        location = /healthz {
            access_log off;
            return 200 "ok\n";
        }

        # ── oauth2-proxy: 認証チェック ────────────────────────
        location = /oauth2/auth {
            internal;
            proxy_pass              http://oauth2-proxy;
            proxy_set_header        Host            $host;
            proxy_set_header        X-Real-IP       $remote_addr;
            proxy_set_header        X-Scheme        $scheme;
            proxy_set_header        Content-Length  "";
            proxy_pass_request_body off;

            proxy_buffer_size       32k;
            proxy_buffers           8 32k;
            proxy_busy_buffers_size 64k;
        }

        # ── oauth2-proxy: サインイン・コールバック等 ──────────
        location /oauth2/ {
            proxy_pass       http://oauth2-proxy;
            proxy_set_header Host                    $host;
            proxy_set_header X-Real-IP               $remote_addr;
            proxy_set_header X-Scheme                $scheme;
            proxy_set_header X-Auth-Request-Redirect $request_uri;
        }

        # ── oauth2-proxy: サインアウト ────────────────────────
        location = /oauth2/sign_out {
            proxy_pass       http://oauth2-proxy;
            proxy_set_header Host            $host;
            proxy_set_header X-Real-IP       $remote_addr;
            proxy_set_header X-Forwarded-Uri $request_uri;
        }

        # ── httpbin (認証必須) ───────────────────────────────
        # /httpbin/ → httpbin の / にプレフィックスを除いてルーティング
        location /httpbin/ {
            auth_request   /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            # ユーザー情報ヘッダー (--set-xauthrequest)
            auth_request_set $user  $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;
            proxy_set_header X-User  $user;
            proxy_set_header X-Email $email;

            # ID トークン
            auth_request_set $authz $upstream_http_authorization;
            proxy_set_header X-Id-Token $id_token;

            # アクセストークン (--pass-access-token)
            auth_request_set $access_token $upstream_http_x_auth_request_access_token;
            proxy_set_header X-Access-Token $access_token;

            # Cookie リフレッシュ (--cookie-refresh)
            auth_request_set $auth_cookie $upstream_http_set_cookie;
            add_header Set-Cookie $auth_cookie;

            # 4KB 超の分割 Cookie 対応 (--set-authorization-header)
            auth_request_set $auth_cookie_name_upstream_1 $upstream_cookie_auth_cookie_name_1;
            if ($auth_cookie ~* "(; .*)") {
                set $auth_cookie_name_0 $auth_cookie;
                set $auth_cookie_name_1 "auth_cookie_name_1=$auth_cookie_name_upstream_1$1";
            }
            if ($auth_cookie_name_upstream_1) {
                add_header Set-Cookie $auth_cookie_name_0;
                add_header Set-Cookie $auth_cookie_name_1;
            }

            # /httpbin/ プレフィックスを除去して httpbin へ転送
            proxy_pass http://httpbin/;
        }

        # ── アプリケーション (認証必須) ───────────────────────
        location / {
            auth_request   /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            # ユーザー情報ヘッダー (--set-xauthrequest)
            auth_request_set $user  $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;
            proxy_set_header X-User  $user;
            proxy_set_header X-Email $email;

            # ID トークン
            auth_request_set $authz $upstream_http_authorization;
            proxy_set_header X-Id-Token $id_token;

            # アクセストークン (--pass-access-token)
            auth_request_set $access_token $upstream_http_x_auth_request_access_token;
            proxy_set_header X-Access-Token $access_token;

            # Cookie リフレッシュ (--cookie-refresh)
            auth_request_set $auth_cookie $upstream_http_set_cookie;
            add_header Set-Cookie $auth_cookie;

            # 4KB 超の分割 Cookie 対応 (--set-authorization-header)
            auth_request_set $auth_cookie_name_upstream_1 $upstream_cookie_auth_cookie_name_1;
            if ($auth_cookie ~* "(; .*)") {
                set $auth_cookie_name_0 $auth_cookie;
                set $auth_cookie_name_1 "auth_cookie_name_1=$auth_cookie_name_upstream_1$1";
            }
            if ($auth_cookie_name_upstream_1) {
                add_header Set-Cookie $auth_cookie_name_0;
                add_header Set-Cookie $auth_cookie_name_1;
            }

            proxy_pass http://nextapp;
        }
    }
}
